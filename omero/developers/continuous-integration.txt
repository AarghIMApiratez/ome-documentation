Continous integration workflow
==============================

.. _Sphinx: http://sphinx-doc.org/
.. _Wikipedia: http://en.wikipedia.org/wiki/Main_Page
.. _openmicroscopy.git: https://github.com/openmicroscopy/openmicroscopy
.. _bioformats.git: https://github.com/openmicroscopy/bioformats
.. _ome-documentation.git: https://github.com/openmicroscopy/ome-documentation
.. _scripts.git: https://github.com/ome/scripts

Definitions
-----------

Versioning
^^^^^^^^^^

.. glossary::

	Major release

		What Sphinx_ calls a “version number” is defined on Wikipedia_ as a
		“minor number” and in OMERO is typically considered a major release,
		e.g. |version|.

	Point release

		Similarly, a Sphinx_ “release number” is a “revision number” on
		Wikipedia_ and an OMERO point release, e.g. |release|.

Labels
^^^^^^

Labels are applied to PRs on github under the “Issues” tab of each repository
(openmicroscopy.git_, bioformats.git_, scripts.git_, ome-documentation.git_)

The current release consists of PRs labelled with “|devbranch|”, which is the 
name of the branch which they will be merged into. This is work on the stable
release version which will only be released as a point release.

The next major release consists of PRs labelled with “develop”, which is also
the name of the branch which they will be merged into.

Two labels are used in the PR reviewing process: “include” and “exclude”. The
“include” label allows to include a PR opened by a non-member of the
organization in the merge builds for review. The “exclude” label allows to
exclude a PR opened by any user from the merge builds.

Objectives of document review workflow
--------------------------------------

Integrate and release changes in the documentation of the current release.
Improve review for next OMERO major release vs next OMERO point release.
Use this documentation review workflow as an example on how other review
workflows can and should function.

Proposal
--------

Maintain two development branches under the ome-documentation.git_ repository:

* |devbranch|, associated with current OMERO major release: |version|
* develop, associated with the next OMERO major release

such that it is possible to release both the current point releases
immediately, while still working on more major releases by ensuring that
(nearly) all commits that are applied to |devbranch| are applied to develop in
order to prevent regressions.

Caveats include:

* more branches to manage, maintain and keep in sync
* PRs need to be opened against relevant development branch
* more integration jobs to run
* impact of OMERO documentation change on user base

..  |merge| replace:: Merge PRs using :ref:`scc merge`
..  |buildOMERO| replace:: Build the server using :source:`OMERO.sh <docs/hudson/OMERO.sh>`
..  |archiveOMEROartifacts| replace:: Archive the build artifacts
..  |deployOMERO| replace:: Deploy the server under :file:`~/OMERO-CURRENT` on
..  |promoteOMERO| replace:: copy the artifacts to necromancer
..  |buildVM| replace:: Build a |VM| using :source:`docs/install/VM/omerovm.sh`
..  |updatesubmodules| replace:: Update submodules using ``scc update-submodules``

OMERO jobs
----------

.. list-table::
	:header-rows: 1

	- 	* Job task
		* Next point release
		* Next major release

	- 	* Build OMERO using Ice 3.3
		* :term:`OMERO-stable`
		* :term:`OMERO-trunk`

	- 	* Build OMERO using Ice 3.4
		* :term:`OMERO-stable-ice34`
		* :term:`OMERO-trunk-ice34`

	- 	* Build an OMERO Virtual Appliacne
		* :term:`OMERO-stable-virtualbox`
		* :term:`OMERO-trunk-virtualbox`

	- 	* Review OMERO PRs using Ice 33
		* :term:`OMERO-merge-stable`
		* :term:`OMERO-merge-develop`

	- 	* Review OMERO PRs using Ice 3.4
		* :term:`OMERO-merge-stable-ice34`
		* :term:`OMERO-merge-develop-ice34`

	- 	* Review OMERO PRs using a Virtual Appliance
		* :term:`OMERO-merge-stable-virtualbox`
		* :term:`OMERO-merge-develop-virtualbox`

	- 	* Update submodules
		* :term:`OMERO-submods-stable`
		* :term:`OMERO-submods-develop`

Next point release
^^^^^^^^^^^^^^^^^^

The branch for the next point release of OMERO is |devbranch|. All jobs are
listed under the :jenkinsview:`Stable <2.%20Stable>` view tab of Jenkins.

.. glossary::


	:jenkinsjob:`OMERO-stable`

		Build the |devbranch| branch of OMERO with Ice 3.3

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|

	:jenkinsjob:`OMERO-stable-ice34`

		Build the |devbranch| branch of OMERO using Ice 3.4

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|

	:jenkinsjob:`OMERO-stable-virtualbox`

		Build a Virtual Appliance from the |devbranch| branch of OMERO

		#. |buildVM|

	:jenkinsjob:`OMERO-merge-stable`

		Review the PRs opened against the |devbranch| branch of OMERO with Ice
		3.3

		#. |merge| and push to snoopycrimecop/merge/|devbranch|/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. |deployOMERO| howe.openmicroscopy.org.uk

	:jenkinsjob:`OMERO-merge-stable-ice34`

		Review the PRs opened against the |devbranch| branch of OMERO with Ice
		3.4

		#. Checkout snoopycrimecop/merge/|devbranch|/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|

	:jenkinsjob:`OMERO-merge-stable-virtualbox`

		Build a Virtual Appliance from the |devbranch| branch with the PRs
		opened against the |devbranch| branch of OMERO

		#. Checkout snoopycrimecop/merge/|devbranch|/latest
		#. |buildVM|

	:jenkinsjob:`OMERO-submods-stable`

		Update the submodules on the |devbranch| branch

		#. |updatesubmodules| and push to snoopycrimecop/merge/|devbranch|/submodules
		#. Open a PR or update existing PR if submodules are updated

Next major release
^^^^^^^^^^^^^^^^^^

The branch for the next major release of OMERO is develop. All jobs are listed
under the :jenkinsview:`Trunk <1.%20Trunk>` view tab of Jenkins.

.. glossary::

	:jenkinsjob:`OMERO-trunk`

		Build the develop branch of OMERO with Ice 3.3.

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|

	:jenkinsjob:`OMERO-trunk-ice34`

		Build the develop branch of OMERO using Ice 3.4

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|

	:jenkinsjob:`OMERO-trunk-virtualbox`

		Build a Virtual Appliance from the develop branch of OMERO

		#. |buildVM|
	
	:jenkinsjob:`OMERO-merge-develop`

		Review the PRs opened against the develop branch of OMERO with Ice
		3.3

		#. |merge| and push to snoopycrimecop/merge/develop/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. |deployOMERO| gretzky.openmicroscopy.org.uk

	:jenkinsjob:`OMERO-merge-develop-ice34`

		Review the PRs opened against the develop branch of OMERO with Ice
		3.4

		#. Checkout snoopycrimecop/merge/develop/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|

	:jenkinsjob:`OMERO-merge-develop-virtualbox`

		Build a Virtual Appliance from the develop branch with the PRs
		opened against the develop branch of OMERO

		#. Checkout snoopycrimecop/merge/develop/latest
		#. |buildVM|

	:jenkinsjob:`OMERO-submods-develop`

		Update the submodules on the develop branch

		#. |updatesubmodules| and push to snoopycrimecop/merge/develop/submodules
		#. Open a PR or update existing PR if submodules are updated

Bio-Formats jobs
----------------

..  |buildBF| replace:: Build Bio-Formats using ``ant clean jars tools tools-ome utils dist-bftools``
..  |testBF| replace:: Run Bio-Formats tests using ``ant test-common test-ome-xml test-formats test-ome-io``
..  |fulltestBF| replace:: Run Bio-Formats full test-suite using ``ant test``

All jobs are listed under the :jenkinsview:`Bio-Formats` view tab of Jenkins.

.. list-table::
	:header-rows: 1

	- 	* Job task
		* Next point release
		* Next major release

	- 	* Build Bio-Formats
		* :term:`BIOFORMATS-stable`
		* :term:`BIOFORMATS-trunk`

	- 	* Publish Bio-Formats to the LOCI Nexus repository
		* :term:`BIOFORMATS-maven-stable`
		* :term:`BIOFORMATS-maven`

	- 	* Review Bio-Formats PRs
		* :term:`BIOFORMATS-merge-stable`
		* :term:`BIOFORMATS-merge-develop`

	- 	* Run automated tests against directories on squig
		* :term:`BIOFORMATS-full-repository-stable`
		* :term:`BIOFORMATS-full-repository-develop`


Next point release
^^^^^^^^^^^^^^^^^^

The branch for the next point release of Bio-Formats is |devbranch|.

.. glossary::

	:jenkinsjob:`BIOFORMATS-stable`

		Build the |devbranch| branch of Bio-Formats

		#. |buildBF|
		#. |testBF|
		
	:jenkinsjob:`BIOFORMATS-maven-stable`

		Publish the |devbranch| branch of Bio-Formats to the LOCI Nexus
		repository

	:jenkinsjob:`BIOFORMATS-merge-stable`

		Review the PRs opened against the |devbranch| branch of Bio-Formats by
		running basic unit tests, checking for open file handles, and checking
		for regressions across a representative subset of the data repository
		
		#. |merge|
		#. |buildBF|
		#. |fulltestBF|

	:jenkinsjob:`BIOFORMATS-full-repository-stable`

		Review the PRs opened against the |devbranch| branch of Bio-Formats by
		running automated tests against directories on squig

		#. |merge|
		#. Run tests against directories configured by ``--test dirname``
		   comments on the PRs

Next major release
^^^^^^^^^^^^^^^^^^

The branch for the next major release of Bio-Formats is develop.

.. glossary::

	:jenkinsjob:`BIOFORMATS-trunk`

		Build the develop branch of Bio-Formats

		#. |buildBF|
		#. |testBF|

	:jenkinsjob:`BIOFORMATS-maven`

		Publish the develop branch of Bio-Formats to the LOCI Nexus repository

	:jenkinsjob:`BIOFORMATS-merge-develop`

		Review the PRs opened against the develop branch of Bio-Formats by
		running basic unit tests, checking for open file handles, and checking
		for regressions across a representative subset of the data repository

		#. |merge|
		#. |buildBF|
		#. |fulltestBF|

	:jenkinsjob:`BIOFORMATS-full-repository-develop`

		Review the PRs opened against the develop branch of Bio-Formats by
		running automated tests against directories on squig

		#. |merge|
		#. Run tests against directories configured by ``--test dirname``
		   comments on the PRs

		
..  |sphinxbuild| replace:: Build HTML and PDF Sphinx documentation using ``make clean html latexpdf``
..  |linkcheck| replace:: Run ``make linkcheck`` and :ref:`parse the Sphinx linkcheck output <linkcheck_parser>`.
..  |ssh-doc| replace:: SSH doc and PDF to
..  |deploy-doc| replace:: Use :ref:`scc deploy` to update

Documentation jobs
------------------

All documentation jobs are listed under the :jenkinsview:`Docs <Docs>` view
tab of Jenkins.

.. list-table::
	:header-rows: 1

	- 	* Job task
		* Current major release
		* Next point release
		* Next major release

	- 	* Publish OMERO documentation
		* :term:`OMERO-docs-release-stable`
		* N/A
		* N/A

	- 	* Publish Bio-Formats documentation
		* :term:`BIOFORMATS-docs-release-stable`
		* N/A
		* N/A

	- 	* Publish OME Model documentation
		* :term:`FORMATS-docs-release-stable`
		* N/A
		* N/A

	- 	* Review OMERO documentation PRs
		* :term:`OMERO-docs-merge-stable`
		* :term:`OMERO-docs-merge-stable`
		* :term:`OMERO-docs-merge-develop`

	- 	* Review Bio-Formats documentation PRs
		* :term:`BIOFORMATS-docs-merge-stable`
		* :term:`BIOFORMATS-docs-merge-stable`
		* :term:`BIOFORMATS-docs-merge-develop`

	- 	* Review OME Model documentation PRs
		* :term:`FORMATS-docs-merge-stable`
		* :term:`FORMATS-docs-merge-stable`
		* :term:`FORMATS-docs-merge-develop`

Configuration
^^^^^^^^^^^^^

For all jobs building documentation using Sphinx,
- :envvar:`SPHINXOPTS` variable is set to ``-W -D html_theme=plone_match``,
- the release number of the job is controlled by the corresponding environment
variable: :envvar:`OMERO_RELEASE`, :envvar:`BF_RELEASE` or
:envvar:`FORMATS_RELEASE`,
- the source code links use the :envvar:`SOURCE_USER` and
:envvar:`SOURCE_BRANCH` environment variables.
- for Bio-Formats and OMERO, the Jenkins job name is set by the :envvar:`JENKINS_JOB` environment variable.
- the release number of the job is controlled by the corresponding environment
variable: :envvar:`OMERO_RELEASE`, :envvar:`BF_RELEASE` or
:envvar:`FORMATS_RELEASE`.
		
Current release
^^^^^^^^^^^^^^^

The branch for the current release of OMERO/Bio-Formats/OME model is
|devbranch|.

.. glossary::

	:jenkinsjob:`OMERO-docs-release-stable`

		Build the |devbranch| of the OMERO documentation and publish the
		official documentation for the current release of OMERO

		#. |sphinxbuild|
		#. |linkcheck|
		#. If the build is promoted,
			#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/ome-release.tmp`
			#. |deploy-doc| http://www.openmicroscopy.org/site/support/omero4/

	:jenkinsjob:`BIOFORMATS-docs-release-stable`

		Build the |devbranch| of the Bio-Formats documentation and publish the
		official documentation for the current release of Bio-Formats

		#. |sphinxbuild|
		#. |linkcheck|
		#. If the build is promoted,
			#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/bf-release.tmp`
			#. |deploy-doc| http://www.openmicroscopy.org/site/support/bio-formats/

	:jenkinsjob:`FORMATS-docs-release-stable`

		Build the |devbranch| of the OME Model documentation and publish the
		official documentation for the current release of Bio-Formats

		#. |sphinxbuild|
		#. |linkcheck|
		#. If the build is promoted,
			#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/formats-release.tmp`
			#. |deploy-doc| http://www.openmicroscopy.org/site/support/ome-model/

Next point release
^^^^^^^^^^^^^^^^^^

The branch for the next point release of OMERO/Bio-Formats/OME model is
|devbranch|.

.. glossary::

	:jenkinsjob:`OMERO-docs-merge-stable`

		Review the PRs opened against the |devbranch| branch of the OMERO
		documentation

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/ome-staging.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/omero4-staging/

	:jenkinsjob:`BIOFORMATS-docs-merge-stable`

		Review the PRs opened against the |devbranch| branch of the
		Bio-Formats documentation

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/bf-staging.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/bio-formats-staging/

	:jenkinsjob:`FORMATS-docs-merge-stable`

		Review the PRs opened against the |devbranch| branch of the OME Model
		documentation

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/formats-staging.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/ome-model-staging/

Next major release
^^^^^^^^^^^^^^^^^^

The branch for the next major release of OMERO/Bio-Formats/OME model is
develop.

.. glossary::

	:jenkinsjob:`OMERO-docs-merge-develop`

		Review the PRs opened against the develop branch of the OMERO
		documentation

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/ome-develop.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/omero4-develop/

	:jenkinsjob:`BIOFORMATS-docs-merge-develop`

		Review the PRs opened against the develop branch of the Bio-Formats
		documentation

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/bf-develop.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/bio-formats-develop/

	:jenkinsjob:`FORMATS-docs-merge-develop`

		Review the PRs opened against the develop branch of the OME Model
		documentation

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/formats-develop.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/ome-model-develop/

.. _linkcheck_parser:

Linkcheck output parser
^^^^^^^^^^^^^^^^^^^^^^^

.. _Warnings Plugin: https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin

The :file:`output.txt` file generated by Sphinx ``linkcheck`` builder is
parsed using the `Warnings Plugin`_. Depending on the nature of the links,
warnings are generated as described in the following table:

====== ================ ========
Type   Error code       Priority
====== ================ ========
local                   High
broken HTTP Error 404   Normal
broken Anchor not found Normal
broken HTTP Error 403   Low
====== ================ ========

The build is marked as FAILED or UNSTABLE if the number of warnings of a given
category exceeds a threshold. The table below lists the thresholds used for
all the documentation builds:

======== ====== ========
Priority FAILED UNSTABLE
======== ====== ========
High     0
Normal          0
Low             10
======== ====== ========

Schematic drawing
-----------------

.. image:: /images/CI-workflow.png
	:align: center
	:alt: Continuous Integration workflow
	:width: 55%
