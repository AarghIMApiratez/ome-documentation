Continous integration workflow
==============================

.. _Sphinx: http://sphinx-doc.org/
.. _Wikipedia: http://en.wikipedia.org/wiki/Main_Page
.. _openmicroscopy.git: https://github.com/openmicroscopy/openmicroscopy
.. _bioformats.git: https://github.com/openmicroscopy/bioformats
.. _ome-documentation.git: https://github.com/openmicroscopy/ome-documentation
.. _scripts.git: https://github.com/ome/scripts

Definitions
-----------

Versioning
^^^^^^^^^^

.. glossary::

	Major release

		What Sphinx_ calls a “version number” is defined on Wikipedia_ as a
		“minor number” and in OMERO is typically considered a major release,
		e.g. |version|.

	Point release

		Similarly, a Sphinx_ “release number” is a “revision number” on
		Wikipedia_ and an OMERO point release, e.g. |release|.

Labels
^^^^^^

Labels are applied to PRs on github under the “Issues” tab of each repository
(openmicroscopy.git_, bioformats.git_, scripts.git_, ome-documentation.git_)

The current release consists of PRs labelled with “|devbranch|”, which is the 
name of the branch which they will be merged into. This is work on the stable
release version which will only be released as a point release.

The next major release consists of PRs labelled with “develop”, which is also
the name of the branch which they will be merged into.

Two labels are used in the PR reviewing process: “include” and “exclude”. The
“include” label allows to include a PR opened by a non-member of the
organization in the merge builds for review. The “exclude” label allows to
exclude a PR opened by any user from the merge builds.

Objectives of document review workflow
--------------------------------------

Integrate and release changes in the documentation of the current release.
Improve review for next OMERO major release vs next OMERO point release.
Use this documentation review workflow as an example on how other review
workflows can and should function.

Proposal
--------

Maintain two development branches under the ome-documentation.git_ repository:

* |devbranch|, associated with current OMERO major release: |version|
* develop, associated with the next OMERO major release

such that it is possible to release both the current point releases
immediately, while still working on more major releases by ensuring that
(nearly) all commits that are applied to |devbranch| are applied to develop in
order to prevent regressions.

Caveats include:

* more branches to manage, maintain and keep in sync
* PRs need to be opened against relevant development branch
* more integration jobs to run
* impact of OMERO documentation change on user base

..  |merge| replace:: Merge PRs using :ref:`scc merge`
..  |buildOMERO| replace:: Build the server using :source:`OMERO.sh <docs/hudson/OMERO.sh>`
..  |archiveOMEROartifacts| replace:: Archive the build artifacts
..  |deployOMERO| replace:: Deploy the server under :file:`~/OMERO-CURRENT` on
..  |promoteOMERO| replace:: copy the artifacts to necromancer

OMERO jobs
----------

.. list-table::
	:header-rows: 1

	- 	* Job task
		* Current major release
		* Next major release

	- 	* Build OMERO using Ice 3.3
		* :term:`OMERO-stable`
		* :term:`OMERO-trunk`

	- 	* Build OMERO using Ice 3.4
		* :term:`OMERO-stable-ice34`
		* :term:`OMERO-trunk-ice34`

	- 	* Review OMERO PRs using Ice 33
		* :term:`OMERO-merge-stable`
		* :term:`OMERO-merge-develop`

	- 	* Review OMERO PRs using Ice 3.4
		* :term:`OMERO-merge-stable-ice34`
		* :term:`OMERO-merge-develop-ice34`

Current major release
^^^^^^^^^^^^^^^^^^^^^

The branch for the current major release is |devbranch|. All jobs are listed
under the :jenkinsview:`Stable <2.%20Stable>` view tab of Jenkins.

.. glossary::


	:jenkinsjob:`OMERO-stable`

		Build current release of OMERO using Ice 3.3

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|

	:jenkinsjob:`OMERO-stable-ice34`

		Build current release of OMERO using Ice 3.4

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|

	:jenkinsjob:`OMERO-merge-stable`

		Review OMERO PRs for the next point release

		#. |merge| and push to snoopycrimecop/merge/|devbranch|/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. |deployOMERO| howe.openmicroscopy.org.uk

	:jenkinsjob:`OMERO-merge-stable-ice34`

		Review OMERO PRs for the next point release

		#. Checkout snoopycrimecop/merge/|devbranch|/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|

Next major release
^^^^^^^^^^^^^^^^^^

The branch for the next major release is develop. All jobs are listed under
the :jenkinsview:`Trunk <1.%20Trunk>` view tab of Jenkins.

.. glossary::

	:jenkinsjob:`OMERO-trunk`

		Build next major release of OMERO

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|

	:jenkinsjob:`OMERO-trunk-ice34`

		Build next major release of OMERO using Ice 3.4

		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. If the build is promoted, |promoteOMERO|
	
	:jenkinsjob:`OMERO-merge-develop`

		Review OMERO PRs for the next major release

		#. |merge| and push to snoopycrimecop/merge/develop/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|
		#. |deployOMERO| gretzky.openmicroscopy.org.uk

	:jenkinsjob:`OMERO-merge-develop-ice34`

		Review OMERO PRs for the next major release

		#. Checkout snoopycrimecop/merge/develop/latest
		#. |buildOMERO|
		#. |archiveOMEROartifacts|

Bio-Formats jobs
----------------

All jobs are listed under the :jenkinsview:`Bio-Formats` view tab of Jenkins.

.. list-table::
	:header-rows: 1

	- 	* Job task
		* Current major release
		* Next major release

	- 	* Build Bio-Formats
		* :term:`BIOFORMATS-stable`
		* :term:`BIOFORMATS-trunk`

	- 	* Review Bio-Formats PRs
		* :term:`BIOFORMATS-per-commit-stable`
		* :term:`BIOFORMATS-per-commit-test`

Current major release
^^^^^^^^^^^^^^^^^^^^^

The branch for the current major release is |devbranch|.

.. glossary::

	:jenkinsjob:`BIOFORMATS-stable`

		Build current release of Bio-Formats

	:jenkinsjob:`BIOFORMATS-per-commit-stable`

		Review Bio-Formats  PRs for the next point release


Next major release
^^^^^^^^^^^^^^^^^^

The branch for the next major release is develop.

.. glossary::

	:jenkinsjob:`BIOFORMATS-trunk`

		Build next major release of Bio-Formats

	:jenkinsjob:`BIOFORMATS-per-commit-test`

		Review Bio-Formats PRs for the next major release

..  |sphinxbuild| replace:: Build HTML and PDF Sphinx documentation using ``make clean html latexpdf``
..  |linkcheck| replace:: Run ``make linkcheck`` and :ref:`parse the Sphinx linkcheck output <linkcheck_parser>`.
..  |ssh-doc| replace:: SSH doc and PDF to
..  |deploy-doc| replace:: Use :ref:`scc deploy` to update

Documentation jobs
------------------

All documentation jobs are listed under the :jenkinsview:`Docs <Docs>` view
tab of Jenkins.

.. list-table::
	:header-rows: 1

	- 	* Job task
		* Current major release
		* Next major release

	- 	* Release OMERO documentation
		* :term:`OMERO-docs-release-stable`
		* N/A

	- 	* Release Bio-Formats documentation
		* :term:`BIOFORMATS-docs-release-stable`
		* N/A

	- 	* Release OME Model documentation
		* :term:`FORMATS-docs-release-stable`
		* N/A

	- 	* Review OMERO documentation PRs
		* :term:`OMERO-docs-merge-stable`
		* :term:`OMERO-docs-merge-develop`

	- 	* Review Bio-Formats documentation PRs
		* :term:`BIOFORMATS-docs-merge-stable`
		* :term:`BIOFORMATS-docs-merge-develop`

	- 	* Review OME Model documentation PRs
		* :term:`FORMATS-docs-merge-stable`
		* :term:`FORMATS-docs-merge-develop`

Configuration
^^^^^^^^^^^^^

For all jobs building documentation using Sphinx,
- :envvar:`SPHINXOPTS` variable is set to ``-W -D html_theme=plone_match``,
- the release number of the job is controlled by the corresponding environment
variable: :envvar:`OMERO_RELEASE`, :envvar:`BF_RELEASE` or
:envvar:`FORMATS_RELEASE`,
- the source code links use the :envvar:`SOURCE_USER` and
:envvar:`SOURCE_BRANCH` environment variables.
- for Bio-Formats and OMERO, the Jenkins job name is set by the :envvar:`JENKINS_JOB` environment variable.
- the release number of the job is controlled by the corresponding environment
variable: :envvar:`OMERO_RELEASE`, :envvar:`BF_RELEASE` or
:envvar:`FORMATS_RELEASE`.
		
Current release
^^^^^^^^^^^^^^^

.. glossary::

	:jenkinsjob:`OMERO-docs-release-stable`

		Update the official documentation for the current OMERO release

		#. |sphinxbuild|
		#. |linkcheck|
		#. If the build is promoted,
			#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/ome-release.tmp`
			#. |deploy-doc| http://www.openmicroscopy.org/site/support/omero4/

	:jenkinsjob:`BIOFORMATS-docs-release-stable`

		Update the official documentation for the current Bio-Formats release

		#. |sphinxbuild|
		#. |linkcheck|
		#. If the build is promoted,
			#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/bf-release.tmp`
			#. |deploy-doc| http://www.openmicroscopy.org/site/support/bio-formats/

	:jenkinsjob:`FORMATS-docs-release-stable`

		Update the official documentation for the current OME Model release

		#. |sphinxbuild|
		#. |linkcheck|
		#. If the build is promoted,
			#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/formats.tmp`
			#. |deploy-doc| http://www.openmicroscopy.org/site/support/ome-model/

Next point release
^^^^^^^^^^^^^^^^^^^

.. glossary::

	:jenkinsjob:`OMERO-docs-merge-stable`

		Review doc PRs for the current OMERO release or for the next OMERO
		point release

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/ome-staging.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/omero4-staging/

	:jenkinsjob:`BIOFORMATS-docs-merge-stable`

		Review doc PRs for the current Bio-Formats release or for the next
		Bio-Formats point release

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/bf-staging.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/bio-formats-staging/

	:jenkinsjob:`FORMATS-docs-merge-stable`

		Review doc PRs for the current OME Model release or for the next
		Bio-Formats point release

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/formats-staging.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/ome-model-staging/

Next major release
^^^^^^^^^^^^^^^^^^

.. glossary::

	:jenkinsjob:`OMERO-docs-merge-develop`

		Review doc PRs for the next OMERO major release

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/ome-develop.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/omero4-develop/

	:jenkinsjob:`BIOFORMATS-docs-merge-develop`

		Review doc PRs for the next Bio-Formats major release

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/bf-develop.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/bio-formats-develop/

	:jenkinsjob:`FORMATS-docs-merge-develop`

		Review doc PRs for the next OME Model major release

		#. |merge|
		#. |sphinxbuild|
		#. |linkcheck|
		#. |ssh-doc| :file:`/var/www/www.openmicroscopy.org/sphinx-docs/formats-develop.tmp`
		#. |deploy-doc| http://www.openmicroscopy.org/site/support/ome-model-develop/

.. _linkcheck_parser:

Linkcheck output parser
^^^^^^^^^^^^^^^^^^^^^^^

.. _Warnings Plugin: https://wiki.jenkins-ci.org/display/JENKINS/Warnings+Plugin

The :file:`output.txt` file generated by Sphinx ``linkcheck`` builder is
parsed using the `Warnings Plugin`_. Depending on the nature of the links,
warnings are generated as described in the following table:

====== ================ ========
Type   Error code       Priority
====== ================ ========
local                   High
broken HTTP Error 404   Normal
broken Anchor not found Normal
broken HTTP Error 403   Low
====== ================ ========

The build is marked as FAILED or UNSTABLE if the number of warnings of a given
category exceeds a threshold. The table below lists the thresholds used for
all the documentation builds:

======== ====== ========
Priority FAILED UNSTABLE
======== ====== ========
High     0
Normal          0
Low             10
======== ====== ========

Schematic drawing
-----------------

.. image:: /images/CI-workflow.png
	:align: center
	:alt: Continuous Integration workflow
	:width: 55%
